<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SwiftPost</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 40px auto;
      padding: 0 20px;
      background: #f9fafb;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
    }
    .tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
      gap: 10px;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      font-weight: bold;
      color: #555;
    }
    .tab.active {
      border-color: #007bff;
      color: #007bff;
    }
    .form-container {
      border: 1px solid #ddd;
      padding: 20px;
      border-radius: 8px;
      background: white;
      max-width: 400px;
      margin: 0 auto 30px auto;
      box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: 600;
    }
    input, select, textarea, button {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }
    button {
      margin-top: 20px;
      background: #007bff;
      border: none;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    button:disabled {
      background: #a3cdfd;
      cursor: default;
    }
    .nav-buttons {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
      gap: 10px;
    }
    .nav-buttons button {
      width: auto;
      padding: 8px 18px;
      background: #eee;
      color: #333;
      border: 1px solid #ccc;
      font-weight: 600;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }
    .nav-buttons button.active {
      background: #007bff;
      color: white;
      border-color: #007bff;
    }
    ul {
      list-style: none;
      padding-left: 0;
      margin-top: 10px;
    }
    li {
      background: white;
      margin-bottom: 15px;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgb(0 0 0 / 0.1);
    }
    li b {
      display: inline-block;
      width: 70px;
    }
    .message-date {
      font-size: 11px;
      color: #666;
      margin-top: 8px;
      text-align: right;
    }
    .signout-btn {
      float: right;
      background: #dc3545;
      border: none;
      color: white;
      font-weight: 600;
      padding: 6px 14px;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 20px;
      transition: background-color 0.2s ease;
    }
    .signout-btn:hover {
      background: #c82333;
    }
    .compose-container {
      margin-top: 30px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
    }
  </style>
</head>
<body>
  <h1>SwiftPost Messaging</h1>
  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script>
    const { useState, useEffect } = React;

    const BACKEND_URL = 'http://localhost:10000';

    function AuthForm({ mode, onSubmit, loading }) {
      const [username, setUsername] = useState('');
      const [domain, setDomain] = useState('tiktok.com');
      const [password, setPassword] = useState('');

      function handleSubmit() {
        if (!username.trim() || !password) {
          alert('Please fill in all fields');
          return;
        }
        const email = username.trim() + '@' + domain;
        onSubmit(email, password);
      }

      return (
        React.createElement('div', { className: 'form-container' },
          React.createElement('h2', null, mode === 'login' ? 'Login' : 'Sign Up'),

          React.createElement('label', null, 'Username'),
          React.createElement('input', {
            type: 'text',
            value: username,
            onChange: e => setUsername(e.target.value),
            disabled: loading,
            placeholder: 'Your username (e.g. tiki)'
          }),

          React.createElement('label', null, 'Domain'),
          React.createElement('select', {
            value: domain,
            onChange: e => setDomain(e.target.value),
            disabled: loading,
          },
            React.createElement('option', { value: 'tiktok.com' }, 'tiktok.com'),
            React.createElement('option', { value: 'email.com' }, 'email.com'),
          ),

          React.createElement('label', null, 'Password'),
          React.createElement('input', {
            type: 'password',
            value: password,
            onChange: e => setPassword(e.target.value),
            disabled: loading,
            placeholder: 'Password',
          }),

          React.createElement('button', { onClick: handleSubmit, disabled: loading },
            loading ? (mode === 'login' ? 'Logging in...' : 'Signing up...') : (mode === 'login' ? 'Login' : 'Sign Up'))
        )
      );
    }

    function MessageList({ messages, inbox }) {
      if (!messages.length) return React.createElement('p', null, 'No messages');

      return React.createElement('ul', null,
        messages.map(msg =>
          React.createElement('li', { key: msg.id },
            React.createElement('div', null,
              React.createElement('b', null, 'Subject: '), msg.subject
            ),
            React.createElement('div', null,
              React.createElement('b', null, inbox ? 'From: ' : 'To: '),
              inbox ? msg.sender_id : msg.recipient_id
            ),
            React.createElement('p', null, msg.body),
            React.createElement('div', { className: 'message-date' }, new Date(msg.created_at).toLocaleString())
          )
        )
      );
    }

    function App() {
      const [mode, setMode] = useState('login'); // 'login' or 'signup'
      const [session, setSession] = useState(null);
      const [token, setToken] = useState(null);
      const [loading, setLoading] = useState(false);

      // Messages & UI state
      const [inbox, setInbox] = useState(true);
      const [messages, setMessages] = useState([]);
      const [recipient, setRecipient] = useState('');
      const [subject, setSubject] = useState('');
      const [body, setBody] = useState('');

      useEffect(() => {
        const savedToken = localStorage.getItem('token');
        if (savedToken) {
          setToken(savedToken);
          setSession(true);
          fetchMessages(true, savedToken);
        }
      }, []);

      async function signUp(email, password) {
        setLoading(true);
        try {
          const res = await fetch(`${BACKEND_URL}/signup`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password }),
          });
          const data = await res.json();
          if (res.ok) {
            alert('Signup successful! Please confirm your email before logging in.');
            setMode('login');
          } else {
            alert(data.error || 'Signup failed');
          }
        } catch (e) {
          alert('Signup error: ' + e.message);
        }
        setLoading(false);
      }

      async function signIn(email, password) {
        setLoading(true);
        try {
          const res = await fetch(`${BACKEND_URL}/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password }),
          });
          const data = await res.json();
          if (res.ok) {
            setToken(data.session.access_token);
            localStorage.setItem('token', data.session.access_token);
            setSession(true);
            fetchMessages(inbox, data.session.access_token);
          } else {
            alert(data.error || 'Login failed');
          }
        } catch (e) {
          alert('Login error: ' + e.message);
        }
        setLoading(false);
      }

      async function signOut() {
        setSession(null);
        setToken(null);
        localStorage.removeItem('token');
        setMessages([]);
        setRecipient('');
        setSubject('');
        setBody('');
      }

      async function fetchMessages(isInbox, authToken = token) {
        if (!authToken) return;
        setLoading(true);
        try {
          const endpoint = isInbox ? 'inbox' : 'sent';
          const res = await fetch(`${BACKEND_URL}/${endpoint}`, {
            headers: { Authorization: `Bearer ${authToken}` },
          });
          const data = await res.json();
          if (res.ok) {
            setMessages(data);
            setInbox(isInbox);
          } else {
            alert(data.error || 'Failed to fetch messages');
            if (res.status === 401) signOut();
          }
        } catch (e) {
          alert('Fetch messages error: ' + e.message);
        }
        setLoading(false);
      }

      async function sendMessage() {
        if (!recipient.trim() || !subject.trim() || !body.trim()) {
          alert('Please fill in all fields');
          return;
        }
        if (!token) {
          alert('You must be logged in to send a message');
          return;
        }
        setLoading(true);
        try {
          const res = await fetch(`${BACKEND_URL}/send-message`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ recipient_id: recipient.trim(), subject: subject.trim(), body: body.trim() }),
          });
          const data = await res.json();
          if (res.ok) {
            alert('Message sent!');
            setRecipient('');
            setSubject('');
            setBody('');
            fetchMessages(inbox);
          } else {
            alert(data.error || 'Failed to send message');
            if (res.status === 401) signOut();
          }
        } catch (e) {
          alert('Send message error: ' + e.message);
        }
        setLoading(false);
      }

      if (!session) {
        return React.createElement('div', null,
          React.createElement('div', { className: 'tabs' },
            React.createElement('div', {
              className: `tab ${mode === 'login' ? 'active' : ''}`,
              onClick: () => !loading && setMode('login')
            }, 'Login'),
            React.createElement('div', {
              className: `tab ${mode === 'signup' ? 'active' : ''}`,
              onClick: () => !loading && setMode('signup')
            }, 'Sign Up')
          ),
          React.createElement(AuthForm, { mode, onSubmit: mode === 'login' ? signIn : signUp, loading })
        );
      }

      return React.createElement('div', null,
        React.createElement('button', { onClick: signOut, className: 'signout-btn' }, 'Sign Out'),

        React.createElement('div', { className: 'nav-buttons' },
          React.createElement('button', {
            onClick: () => fetchMessages(true),
            className: inbox ? 'active' : '',
            disabled: loading
          }, 'Inbox'),
          React.createElement('button', {
            onClick: () => fetchMessages(false),
            className: !inbox ? 'active' : '',
            disabled: loading
          }, 'Sent'),
        ),

        React.createElement('div', null,
          React.createElement('h3', null, inbox ? 'Inbox Messages' : 'Sent Messages'),
          loading && React.createElement('p', null, 'Loading messages...'),
          !loading && React.createElement(MessageList, { messages, inbox })
        ),

        React.createElement('div', { className: 'compose-container' },
          React.createElement('h3', null, 'Compose Message'),
          React.createElement('input', {
            placeholder: 'Recipient User ID',
            value: recipient,
            onChange: e => setRecipient(e.target.value),
            disabled: loading,
          }),
          React.createElement('input', {
            placeholder: 'Subject',
            value: subject,
            onChange: e => setSubject(e.target.value),
            disabled: loading,
          }),
          React.createElement('textarea', {
            placeholder: 'Message body',
            rows: 5,
            value: body,
            onChange: e => setBody(e.target.value),
            disabled: loading,
          }),
          React.createElement('button', { onClick: sendMessage, disabled: loading },
            loading ? 'Sending...' : 'Send')
        )
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
  </script>
</body>
</html>
