<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SwiftPost</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 40px auto;
      padding: 0 20px;
    }
    input, textarea, button {
      display: block;
      width: 100%;
      margin-top: 10px;
      padding: 8px;
      box-sizing: border-box;
    }
    button {
      cursor: pointer;
    }
    ul {
      padding-left: 20px;
    }
    li {
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
    }
  </style>
</head>
<body>
  <h1>SwiftPost Messaging</h1>
  <div id="root"></div>

  <!-- React and ReactDOM from CDN -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

  <script type="text/javascript">
    const { useState, useEffect } = React;

    // Backend base URL
    const BACKEND_URL = 'http://localhost:3000';

    function App() {
      const [session, setSession] = useState(null);
      const [token, setToken] = useState(null); // JWT token from backend
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [messages, setMessages] = useState([]);
      const [inbox, setInbox] = useState(true);
      const [recipient, setRecipient] = useState('');
      const [subject, setSubject] = useState('');
      const [body, setBody] = useState('');
      const [loading, setLoading] = useState(false);

      // Save session/token in localStorage to persist login
      useEffect(() => {
        const savedToken = localStorage.getItem('token');
        if (savedToken) {
          setToken(savedToken);
          setSession(true); // We consider logged in if token exists (no refresh token logic here)
          fetchMessages(inbox, savedToken);
        }
      }, []);

      async function signUp() {
        if (!email || !password) {
          alert('Please provide email and password');
          return;
        }
        setLoading(true);
        const res = await fetch(`${BACKEND_URL}/signup`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        });
        const data = await res.json();
        setLoading(false);
        if (res.ok) {
          alert('Signup successful! Please confirm your email before logging in.');
        } else {
          alert(data.error || 'Signup failed');
        }
      }

      async function signIn() {
        if (!email || !password) {
          alert('Please provide email and password');
          return;
        }
        setLoading(true);
        const res = await fetch(`${BACKEND_URL}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        });
        const data = await res.json();
        setLoading(false);
        if (res.ok) {
          setToken(data.session.access_token);
          localStorage.setItem('token', data.session.access_token);
          setSession(true);
          fetchMessages(inbox, data.session.access_token);
        } else {
          alert(data.error || 'Login failed');
        }
      }

      async function signOut() {
        setSession(null);
        setToken(null);
        localStorage.removeItem('token');
        setMessages([]);
        setEmail('');
        setPassword('');
      }

      async function fetchMessages(isInbox, authToken = token) {
        if (!authToken) return;
        setLoading(true);

        const endpoint = isInbox ? 'inbox' : 'sent';
        const res = await fetch(`${BACKEND_URL}/${endpoint}`, {
          headers: { Authorization: `Bearer ${authToken}` },
        });
        const data = await res.json();
        setLoading(false);

        if (res.ok) {
          setMessages(data);
        } else {
          alert(data.error || 'Failed to fetch messages');
          if (res.status === 401) signOut();
        }
      }

      async function sendMessage() {
        if (!recipient || !subject || !body) {
          alert('Please fill in all fields');
          return;
        }
        if (!token) {
          alert('You must be logged in to send a message');
          return;
        }

        setLoading(true);

        const res = await fetch(`${BACKEND_URL}/send-message`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ recipient_id: recipient, subject, body }),
        });

        const data = await res.json();
        setLoading(false);

        if (res.ok) {
          alert('Message sent!');
          setRecipient('');
          setSubject('');
          setBody('');
          fetchMessages(inbox);
        } else {
          alert(data.error || 'Failed to send message');
          if (res.status === 401) signOut();
        }
      }

      if (!session) {
        return React.createElement('div', { style: { maxWidth: 400, margin: 'auto' } },
          React.createElement('h2', null, 'SwiftPost Login'),
          React.createElement('input', {
            type: 'email',
            placeholder: 'Email',
            value: email,
            onChange: e => setEmail(e.target.value),
            disabled: loading,
          }),
          React.createElement('input', {
            type: 'password',
            placeholder: 'Password',
            value: password,
            onChange: e => setPassword(e.target.value),
            disabled: loading,
          }),
          React.createElement('div', null,
            React.createElement('button', { onClick: signIn, disabled: loading }, loading ? 'Logging in...' : 'Login'),
            React.createElement('button', { onClick: signUp, disabled: loading, style: { marginLeft: 10 } }, loading ? 'Signing up...' : 'Sign Up')
          )
        );
      }

      return React.createElement('div', null,
        React.createElement('h2', null, 'SwiftPost'),
        React.createElement('button', { onClick: signOut, style: { float: 'right' } }, 'Sign Out'),

        React.createElement('div', { style: { marginTop: 20, textAlign: 'center' } },
          React.createElement('button', {
            onClick: () => { setInbox(true); fetchMessages(true); },
            disabled: loading,
            style: { fontWeight: inbox ? 'bold' : 'normal' }
          }, 'Inbox'),
          React.createElement('button', {
            onClick: () => { setInbox(false); fetchMessages(false); },
            disabled: loading,
            style: { marginLeft: 10, fontWeight: !inbox ? 'bold' : 'normal' }
          }, 'Sent')
        ),

        React.createElement('div', { style: { marginTop: 20 } },
          React.createElement('h3', null, inbox ? 'Inbox Messages' : 'Sent Messages'),
          loading && React.createElement('p', null, 'Loading messages...'),
          !loading && messages.length === 0 && React.createElement('p', null, 'No messages'),
          React.createElement('ul', null,
            messages.map(msg => React.createElement('li', { key: msg.id },
              React.createElement('b', null, 'Subject: '), msg.subject, React.createElement('br'),
              React.createElement('b', null, inbox ? 'From: ' : 'To: '),
              inbox ? msg.sender_id : msg.recipient_id, React.createElement('br'),
              React.createElement('p', null, msg.body),
              React.createElement('small', null, new Date(msg.created_at).toLocaleString())
            ))
          )
        ),

        React.createElement('div', { style: { marginTop: 40 } },
          React.createElement('h3', null, 'Compose Message'),
          React.createElement('input', {
            placeholder: 'Recipient User ID',
            value: recipient,
            onChange: e => setRecipient(e.target.value),
            disabled: loading,
          }),
          React.createElement('input', {
            placeholder: 'Subject',
            value: subject,
            onChange: e => setSubject(e.target.value),
            disabled: loading,
          }),
          React.createElement('textarea', {
            placeholder: 'Message body',
            value: body,
            onChange: e => setBody(e.target.value),
            rows: 5,
            disabled: loading,
          }),
          React.createElement('button', { onClick: sendMessage, disabled: loading }, loading ? 'Sending...' : 'Send')
        )
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
  </script>
</body>
</html>
